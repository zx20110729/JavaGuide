# Elasticsearch学习笔记
## Elasticsearch 简介
Elastcisearch 是分布式的文档存储。它能存储和检索复杂的数据结构--序列化成为JSON文档--以 实时 的方式。 换句话说，一旦一个文档被存储在 Elasticsearch 中，它就是可以被集群中的任意节点检索到。
在 Elasticsearch 中， 每个字段的所有数据 都是 默认被索引的 。 即每个字段都有为了快速检索设置的专用倒排索引。而且，不像其他多数的数据库，它能在 相同的查询中 使用所有这些倒排索引，并以惊人的速度返回结果。
## 一、Elasticsearch名词
* index（索引）
 名词index：一个index类似于传统关系型数据库中的一个数据库，是一个存储关系型文档的地方。复数形式为indices或indexes。索引实际指向一个或多个物理分片的逻辑命名空间。
动词索引：就是存储一个document到一个index中以便它可以检索和查询到。非常类似于SQL语句中的insert动作，除了文档已存在时新文档会替换掉老文档。
倒排索引：关系型数据库通过增加一个索引比如B树索引到指定的列上，以便提升检索速度。es和lucene使用了一个叫做倒排索引的结构达到相同的目的。默认的一个document中所有的属性都是被索引的（又一个倒排索引）和可搜索的，一个没有倒排索引的属性是不能被检索到的。
* type
 Deprecated in 6.0.0.
* document（文档）
 文档是被索引的基本信息单位，是最顶层或根部的对象，这个跟对象被序列化为JSON并存储到index中，制定了唯一ID。
ES中文档是不可改变的，如果要修改文档，需要重建索引或进行替换。当修改**整个文档**（PUT）时，es会把旧文档标记为删除，并增加一个全新的文档。尽管不能对旧文档进行访问，但它不会立即消失。当继续索引更多的数据时，es会在后台清理以删除的文档。
使用update API对文档进行**局部修改**时，虽然它似乎对文档直接进行了修改，但实际上 Elasticsearch 按前述完全相同方式执行以下过程：
    * 从旧文档构建JSON
    * 更改该JSON
    * 删除旧文档
    * 索引新文档
  元数据
    * _index： 文档存放的索引
    * _type：文档存放的类型
    * _id：文档的id
    * _version：文档版本号，每次修改时版本号+1
    * _score：
    * _source：
* cluster（集群）
  一个运行中的 Elasticsearch 实例称为一个 节点，而集群是由一个或者多个拥有相同 cluster.name 配置的节点组成， 它们共同承担数据和负载的压力。当有节点加入集群中或者从集群中移除节点时，集群将会重新平均分布所有的数据。
当一个节点被选举成为 主 节点时， **它将负责管理集群范围内的所有变更**，例如增加、删除索引，或者增加、删除节点等。 而**主节点并不需要涉及到文档级别的变更和搜索等操作**，所以当集群只拥有一个主节点的情况下，即使流量的增加它也不会成为瓶颈。 任何节点都可以成为主节点。我们的示例集群就只有一个节点，所以它同时也成为了主节点。
作为用户，我们可以将请求发送到 集群中的任何节点 ，包括主节点。** 每个节点都知道任意文档所处的位置，并且能够将我们的请求直接转发到存储我们所需文档的节点**。 无论我们将请求发送到哪个节点，它都能负责从各个包含我们所需文档的节点收集回数据，并将最终结果返回给客户端。 Elasticsearch 对这一切的管理都是透明的。
* shards（分片）
 一个分片是一个底层的工作单元，仅保存了全部数据的一部分。一个分片也是一个Lucene的实例，它本身是一个完整的搜索引擎。文档被存储和索引到分片上内，但应用程序直接和索引而不是分片交互。
ES利用分片将数据分发到各处，分片是数据的容器，文档保存在分片内，分片又被分配到集群的各个节点里。当集群规模扩大或缩小时，ES会自动的在各个节点迁移分片，使得数据仍然均匀的分布在集群内。
可以在创建索引时为每个索引定义分片和副本的数量。 创建索引后，您还可以随时动态更改副本数。 您可以使用_shrink和_split API更改现有索引的分片数，但这不是一项简单的任务，预先计划正确数量的分片是最佳方法。
一个分片可以是主分片或者副本分片。索引内任意一个文档都归属于一个主分片，所以**主分片的数量决定了索引能够保存的最大数据量**。
理论上，**一个主分片可以存储Integer.MAX_VALUE-128个文档**，但是实际最大值还需要参考你的使用场景：包括你使用的硬件， 文档的大小和复杂程度，索引和查询文档的方式以及你期望的响应时长。

## 相关工具
* [es head](https://github.com/mobz/elasticsearch-head) 工具跨域问题
 config/elasticsearch.yml文件
[相关配置官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-http.html)

 ```
http.cors.enabled: true
http.cors.allow-origin: "*"
http.cors.allow-credentials: true
```
* [es  cerebro](https://github.com/lmenezes/cerebro)集群状态监控工具